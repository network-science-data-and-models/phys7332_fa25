# .github/workflows/deploy-book.yml
name: Build & Deploy Book

on:
  push:
    branches: [ main ]

permissions:
  contents: write    # needed for pushing to gh-pages
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Use your requirements; then pin key tools to avoid drift
          pip install -r requirements.txt || true
          pip install "jupyter-book==0.15.1" "myst-nb==0.17.2" "sphinx-book-theme==1.1.3"

      # Catch missing files referenced by _toc.yml before building
      - name: Preflight: verify ToC paths exist
        run: |
          echo "Checking files referenced in _toc.yml..."
          missing=0
          # check root
          root=$(grep -E '^root:' _toc.yml | awk '{print $2}')
          if [ -n "$root" ]; then
            if [ -f "${root}.md" ] || [ -f "${root}.ipynb" ]; then
              echo "OK root: ${root}"
            else
              echo "MISSING root: ${root}.md|.ipynb"; missing=1
            fi
          fi
          # check chapters
          while read -r line; do
            base=$(echo "$line" | sed -E 's/^[[:space:]]*-[[:space:]]*file:[[:space:]]*//')
            [ -z "$base" ] && continue
            if [ -f "${base}.ipynb" ] || [ -f "${base}.md" ]; then
              echo "OK: ${base}"
            else
              echo "MISSING: ${base}.ipynb|.md"
              missing=1
            fi
          done < <(grep -E '^[[:space:]]*-[[:space:]]*file:' _toc.yml)
          exit $missing

      - name: Build the book (strict, keep-going)
        run: |
          set -o pipefail
          jupyter-book build . -W -n --keep-going 2>&1 | tee _jb_build.log

      - name: Show last 200 lines of build log if index missing
        if: ${{ !hashFiles('_build/html/index.html') }}
        run: |
          echo "=== tail _jb_build.log ==="
          tail -n 200 _jb_build.log || true
          echo "=== repo top-level ==="
          ls -la
          echo "=== notebooks/ (first two levels) ==="
          find notebooks -maxdepth 2 -type f | sed 's|^|  |' | head -200 || true

      - name: Verify build produced index.html
        run: test -f _build/html/index.html || (echo "No index.html produced" && exit 1)

      - name: List build output (debug)
        run: |
          echo "Top-level of _build/html:"
          ls -la _build/html | head -100

      # Deploy to GitHub Pages via gh-pages branch (matches your Pages setting)
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_build/html
          publish_branch: gh-pages
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          clean: true
          force_orphan: true
